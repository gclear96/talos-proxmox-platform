apiVersion: batch/v1
kind: Job
metadata:
  name: vault-kubernetes-auth-bootstrap
  namespace: vault
  annotations:
    # Runs from the bootstrap/root app; it must be idempotent and tolerate Vault not being ready yet.
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true,Replace=true
spec:
  backoffLimit: 6
  template:
    spec:
      serviceAccountName: platform-vault
      restartPolicy: OnFailure
      volumes:
        # Vault admin token to perform bootstrap writes.
        # Create this Secret manually (do NOT commit it):
        # kubectl -n vault create secret generic vault-bootstrap-token --from-literal=token=REPLACE_ME
        - name: vault-bootstrap-token
          secret:
            secretName: vault-bootstrap-token
            optional: true
        # Optional: long-lived tokenreview JWT for the platform-vault ServiceAccount.
        # If missing, the script falls back to the pod's own projected SA token.
        - name: vault-tokenreview
          secret:
            secretName: platform-vault-tokenreview
            optional: true
      containers:
        - name: bootstrap
          image: hashicorp/vault:1.20.4
          imagePullPolicy: IfNotPresent
          env:
            - name: VAULT_ADDR
              value: http://platform-vault.vault.svc:8200
          volumeMounts:
            - name: vault-bootstrap-token
              mountPath: /vault-bootstrap
              readOnly: true
            - name: vault-tokenreview
              mountPath: /tokenreview
              readOnly: true
          command:
            - /bin/sh
            - -ec
            - |
              echo "Waiting for vault-bootstrap-token Secret..."
              for i in $(seq 1 3600); do
                if [ -s /vault-bootstrap/token ]; then
                  export VAULT_TOKEN="$(cat /vault-bootstrap/token)"
                  break
                fi
                sleep 2
              done
              if [ -z "${VAULT_TOKEN:-}" ]; then
                echo "Timed out waiting for vault-bootstrap-token Secret."
                exit 1
              fi

              echo "Waiting for Vault to be reachable at ${VAULT_ADDR}..."
              for i in $(seq 1 120); do
                if vault status >/dev/null 2>&1; then
                  break
                fi
                sleep 2
              done
              vault status >/dev/null

              KUBE_HOST="https://${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT}"
              if [ -f /tokenreview/token ] && [ -f /tokenreview/ca.crt ]; then
                echo "Configuring Vault Kubernetes auth using platform-vault tokenreview Secret..."
                TR_JWT="@/tokenreview/token"
                TR_CA="@/tokenreview/ca.crt"
              else
                echo "platform-vault tokenreview Secret not mounted; falling back to this pod's SA token (may expire)."
                TR_JWT="@/var/run/secrets/kubernetes.io/serviceaccount/token"
                TR_CA="@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
              fi

              # Ensure the auth method exists at the mount path External Secrets expects: /auth/kubernetes
              vault auth enable -path=kubernetes kubernetes >/dev/null 2>&1 || true

              echo "Writing auth/kubernetes/config (kubernetes_host=${KUBE_HOST})..."
              vault write auth/kubernetes/config \
                kubernetes_host="${KUBE_HOST}" \
                kubernetes_ca_cert="${TR_CA}" \
                token_reviewer_jwt="${TR_JWT}" \
                disable_iss_validation=true

              # Minimal policy for External Secrets reading KV v2 secrets under the `kv/` mount.
              # NOTE: This is intentionally broad for a homelab; tighten paths as needed.
              vault policy write external-secrets - <<'POLICY'
              path "kv/data/*" {
                capabilities = ["read"]
              }
              path "kv/metadata/*" {
                capabilities = ["list"]
              }
              POLICY

              # Allow common service accounts/namespaces used by this repo.
              vault write auth/kubernetes/role/external-secrets \
                bound_service_account_names="vault-auth,platform-external-secrets" \
                bound_service_account_namespaces="authentik,forgejo,external-secrets" \
                policies="external-secrets" \
                ttl="1h"

              echo "Done."
